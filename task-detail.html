<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Details - Victor</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Config script -->
  <script src="js/config.js"></script>
  <script src="js/notification.js"></script>
  <script src="js/task-utils.js"></script>
  <script src="js/user-display.js"></script>
  <!-- Configure Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#1a73e8',
              dark: '#1557b0',
              light: '#e8f0fe',
            },
            secondary: '#5f6368',
            success: '#0d904f',
            warning: '#f9ab00',
            danger: '#d93025',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-delay-1 { animation-delay: 0.1s; }
    .animate-delay-2 { animation-delay: 0.2s; }
    .animate-delay-3 { animation-delay: 0.3s; }
    
    /* Enhanced card styling */
    .detail-card {
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      border-radius: 0.75rem;
    }
    
    .detail-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    /* Badge and tag styling */
    .task-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    /* Info icon styling */
    .info-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
    }
    
    /* Button hover effect */
    .hover-lift {
      transition: transform 0.15s ease-in-out;
    }
    
    .hover-lift:hover {
      transform: translateY(-1px);
    }
  </style>
  <!-- Font Awesome for the chat icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Custom chat icon CSS -->
  <link rel="stylesheet" href="/css/chat-icon.css">
  <link rel="stylesheet" href="css/chat-icon.css">
  <!-- Add this line in the head section of the file, with the other script imports -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <!-- Header -->
  <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between py-3">
        <a class="text-primary font-bold text-2xl flex items-center" href="index.html">
          <span class="bg-gradient-to-r from-primary to-blue-600 text-white p-1.5 rounded mr-1.5 flex items-center justify-center w-8 h-8">V</span>ictor
        </a>
        
        <!-- Search bar - desktop -->
        <div class="hidden md:flex flex-grow max-w-xl mx-8">
          <div class="relative w-full">
            <input type="text" placeholder="Search tasks..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
            </div>
          </div>
        </div>
        
        <!-- Mobile menu button -->
        <button class="md:hidden text-gray-600 focus:outline-none" id="mobile-menu-button">
          <i class="fas fa-bars text-xl"></i>
        </button>
        
        <!-- Desktop nav menu -->
        <nav class="hidden md:flex items-center space-x-1">
          <a href="index.html" class="px-3 py-2 text-gray-700 hover:text-primary rounded-md transition-colors">Home</a>
          <a href="tasks.html" class="px-3 py-2 text-gray-700 hover:text-primary rounded-md transition-colors">Browse Tasks</a>
          <a href="post-task.html" class="px-3 py-2 text-gray-700 hover:text-primary rounded-md transition-colors">Post a Task</a>
          
          <!-- Notifications dropdown -->
          <div class="relative">
            <button class="p-2 text-gray-600 hover:text-primary rounded-full hover:bg-gray-100 relative" id="notifications-button">
              <i class="fas fa-bell"></i>
              <span class="absolute top-0 right-0 bg-red-500 text-white text-xs w-4 h-4 flex items-center justify-center rounded-full" id="notifications-count">0</span>
            </button>
            <div class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg py-1 z-10 hidden border border-gray-100" id="notifications-dropdown">
              <div class="px-4 py-3 border-b border-gray-100">
                <h3 class="font-semibold text-gray-900">Notifications</h3>
              </div>
              <div class="max-h-64 overflow-y-auto" id="notifications-container">
                <div class="text-center py-4 text-gray-500">No notifications yet</div>
              </div>
            </div>
          </div>
          
          <!-- Chat icon -->
          <a href="chat.html" class="p-2 text-gray-600 hover:text-primary rounded-full hover:bg-gray-100 relative">
            <i class="fas fa-comments"></i>
            <span class="absolute top-0 right-0 bg-red-500 text-white text-xs w-4 h-4 flex items-center justify-center rounded-full" id="chat-count" style="display: none;">0</span>
          </a>
          
          <!-- User dropdown -->
          <div class="relative" id="user-menu-container">
            <button class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-full transition-colors" id="user-menu-button">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-400 to-blue-500 text-white flex items-center justify-center font-bold mr-2" id="user-avatar">V</div>
              <span class="font-medium mr-1" id="username-display">User</span>
              <i class="fas fa-chevron-down text-xs text-gray-500"></i>
            </button>
            <div class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg py-1 z-10 hidden border border-gray-100" id="user-dropdown">
              <div class="px-4 py-3 border-b border-gray-100">
                <p class="text-sm font-medium text-gray-900" id="user-name-dropdown">User</p>
                <p class="text-sm text-gray-500 truncate" id="user-email-dropdown">user@example.com</p>
              </div>
              <a href="dashboard.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-50">
                <i class="fas fa-tachometer-alt w-5 text-gray-400 mr-2"></i> Dashboard
              </a>
              <a href="profile.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-50">
                <i class="fas fa-user-circle w-5 text-gray-400 mr-2"></i> My Profile
              </a>
              <a href="accepted-tasks.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-50">
                <i class="fas fa-check-circle w-5 text-gray-400 mr-2"></i> Tasks I'm Working On
              </a>
              <div class="border-t border-gray-100 my-1"></div>
              <a href="#" id="logout-button" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-50">
                <i class="fas fa-sign-out-alt w-5 text-gray-400 mr-2"></i> Logout
              </a>
            </div>
          </div>
          
          <!-- Login/Signup options (visible when logged out) -->
          <div class="flex items-center space-x-2" id="auth-buttons">
            <a class="px-4 py-2 text-gray-700 font-medium hover:text-primary transition-colors" href="login.html" id="login-menu-item">
              Log In
            </a>
            <a class="px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-md transition-colors" href="signup.html" id="signup-menu-item">
              Sign Up
            </a>
          </div>
        </nav>
      </div>
    </div>
    
    <!-- Mobile menu (hidden by default) -->
    <div class="md:hidden bg-white border-t border-gray-100 px-4 py-2 hidden" id="mobile-menu">
      <!-- Mobile search -->
      <div class="relative mb-4">
        <input type="text" placeholder="Search tasks..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <i class="fas fa-search text-gray-400"></i>
        </div>
      </div>
      
      <div class="flex flex-col space-y-1">
        <a href="index.html" class="px-2 py-2 text-gray-700 hover:bg-gray-50 rounded-md">Home</a>
        <a href="tasks.html" class="px-2 py-2 text-gray-700 hover:bg-gray-50 rounded-md">Browse Tasks</a>
        <a href="post-task.html" class="px-2 py-2 text-gray-700 hover:bg-gray-50 rounded-md">Post a Task</a>
        <a href="chat.html" class="px-2 py-2 text-gray-700 hover:bg-gray-50 rounded-md flex items-center">
          <i class="fas fa-comments w-5 mr-2 text-gray-400"></i> Messages
        </a>
        <div class="border-t border-gray-100 my-1 pt-1" id="mobile-auth-links">
          <a href="login.html" class="px-2 py-2 text-gray-700 hover:bg-gray-50 rounded-md">Log In</a>
          <a href="signup.html" class="px-2 py-2 text-primary font-medium">Create an Account</a>
        </div>
        <div id="mobile-user-links" class="hidden">
          <a class="px-2 py-2 text-gray-700 hover:bg-gray-50 rounded-md flex items-center" href="dashboard.html">
            <i class="fas fa-tachometer-alt w-5 mr-2 text-gray-400"></i> Dashboard
          </a>
          <a class="px-2 py-2 text-gray-700 hover:bg-gray-50 rounded-md flex items-center" href="profile.html">
            <i class="fas fa-user w-5 mr-2 text-gray-400"></i> My Profile
          </a>
          <a class="px-2 py-2 text-gray-700 hover:bg-gray-50 rounded-md flex items-center" href="accepted-tasks.html">
            <i class="fas fa-check-circle w-5 mr-2 text-gray-400"></i> Tasks I'm Working On
          </a>
          <div class="border-t border-gray-100 my-1"></div>
          <a class="px-2 py-2 text-gray-700 hover:bg-gray-50 rounded-md flex items-center" href="#" id="mobile-logout-button">
            <i class="fas fa-sign-out-alt w-5 mr-2 text-gray-400"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </header>

  <main class="pt-20 pb-12">
    <div class="container mx-auto px-4 max-w-7xl">
      <!-- Breadcrumbs -->
      <nav class="mb-4 text-sm">
        <ol class="flex flex-wrap items-center text-gray-600">
          <li><a href="index.html" class="hover:text-primary transition-colors">Home</a></li>
          <li><span class="mx-2 text-gray-400">/</span></li>
          <li><a href="tasks.html" class="hover:text-primary transition-colors">Browse Tasks</a></li>
          <li><span class="mx-2 text-gray-400">/</span></li>
          <li><span class="text-gray-900 font-medium" id="breadcrumb-title">Task Details</span></li>
        </ol>
      </nav>
      
      <!-- Loading state -->
      <div id="loading-container" class="flex flex-col items-center justify-center py-16">
        <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-6"></div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">Loading task details</h3>
        <p class="text-gray-500">Please wait a moment...</p>
      </div>
      
      <!-- Error state (hidden by default) -->
      <div id="error-container" class="bg-red-50 rounded-xl shadow-sm p-12 text-center hidden">
        <div class="inline-block p-6 rounded-full bg-red-100 mb-4">
          <i class="fas fa-exclamation-triangle text-red-500 text-4xl"></i>
        </div>
        <h3 class="text-xl font-bold mb-2">Task not found</h3>
        <p class="text-gray-600 mb-6 max-w-md mx-auto">We couldn't find the task you're looking for. It may have been deleted or the link may be incorrect.</p>
        <a href="tasks.html" class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg inline-flex items-center">
          <i class="fas fa-list mr-2"></i>Browse Available Tasks
        </a>
      </div>
      
      <!-- Task details -->
      <div id="task-details" class="hidden animate-fadeIn">
        <!-- Task Header Banner -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6 detail-card">
          <div id="task-status-banner" class="py-3 px-6 bg-green-50 text-green-700 flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-circle text-xs mr-2"></i>
              <span id="task-status-text" class="font-medium">Open for offers</span>
            </div>
            <span id="task-posted-date" class="text-sm">Posted recently</span>
          </div>
          
          <div class="p-6">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-6">
              <div>
                <h1 id="task-title" class="text-2xl font-bold text-gray-900 mb-3">Task Title</h1>
                <div class="flex flex-wrap gap-2">
                  <span class="task-badge bg-blue-50 text-blue-700" id="task-category">
                    <i class="fas fa-tag mr-1.5 opacity-70"></i>Category
                  </span>
                  <span class="task-badge bg-gray-50 text-gray-700" id="task-location">
                    <i class="fas fa-map-marker-alt mr-1.5 opacity-70"></i>Location
                  </span>
                  <span id="task-urgent-badge" class="task-badge bg-red-50 text-red-700 hidden">
                    <i class="fas fa-exclamation-circle mr-1.5"></i>Urgent
                  </span>
                </div>
              </div>
              
              <div class="text-center md:text-right">
                <div class="text-2xl font-bold text-primary mb-1" id="task-budget">₹5,000</div>
                <div class="text-sm text-gray-500">Budget</div>
              </div>
            </div>
            
            <!-- Description -->
            <div class="prose max-w-none">
              <h2 class="text-xl font-semibold mb-4">Description</h2>
              <div id="task-description" class="text-gray-700"></div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Left Column (Main Content) -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Location details section -->
            <div id="location-details" class="bg-white rounded-xl shadow-sm p-6 hidden detail-card">
              <h2 class="text-xl font-semibold mb-5 flex items-center">
                <i class="fas fa-map-marker-alt text-blue-500 mr-3"></i>Location Details
              </h2>
              <div class="flex items-start mb-5">
                <div class="info-icon bg-blue-100 text-blue-600">
                  <i class="fas fa-location-dot"></i>
                </div>
                <div>
                  <p class="font-medium text-gray-900 mb-1" id="location-display-name">Location</p>
                  <p class="text-gray-600" id="specific-location-display">Specific address details</p>
                </div>
              </div>
              <div class="h-64 w-full bg-gray-100 rounded-lg overflow-hidden" id="location-map">
                <!-- Map will be embedded here with JS -->
                <div class="h-full w-full flex items-center justify-center text-gray-500">
                  <span id="map-placeholder">
                    <i class="fas fa-map-marked-alt text-gray-400 mr-2 text-3xl"></i>
                    Map information will be available soon
                  </span>
                </div>
              </div>
            </div>
            
            <!-- Deadline information section -->
            <div id="deadline-details" class="bg-white rounded-xl shadow-sm p-6 detail-card hidden">
              <h2 class="text-xl font-semibold mb-5 flex items-center">
                <i class="fas fa-calendar-alt text-purple-500 mr-3"></i>Timeline Information
              </h2>
              <div class="flex items-start">
                <div class="info-icon bg-purple-100 text-purple-600">
                  <i class="fas fa-hourglass-half"></i>
                </div>
                <div>
                  <p class="font-medium text-gray-900 mb-1">Required By</p>
                  <p id="deadline-display" class="text-gray-600">No specific deadline</p>
                  <p id="deadline-urgency" class="mt-3 hidden">
                    <span class="task-badge bg-red-50 text-red-600">
                      <i class="fas fa-exclamation-circle mr-1.5"></i>This task is marked as urgent
                    </span>
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Task actions -->
            <div id="task-actions" class="bg-white rounded-xl shadow-sm p-6 detail-card"></div>
            
            <!-- Offers section -->
            <div id="offers-container" class="bg-white rounded-xl shadow-sm p-6 hidden detail-card">
              <div class="flex items-center justify-between mb-5">
                <h2 class="text-xl font-semibold flex items-center">
                  <i class="fas fa-handshake text-green-500 mr-3"></i>Offers
                </h2>
                <span class="task-badge bg-blue-50 text-blue-700" id="offers-count">0 offers</span>
              </div>
              
              <div id="offers-list" class="space-y-4">
                <!-- Offers will be inserted here -->
              </div>
              
              <!-- No offers state -->
              <div id="no-offers" class="text-center py-10 hidden">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gray-100 mb-4">
                  <i class="fas fa-handshake text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">No offers yet</h3>
                <p class="text-gray-500 max-w-md mx-auto">When people make offers on your task, they'll appear here.</p>
              </div>
            </div>
          </div>
          
          <!-- Right Column (Sidebar) -->
          <div class="space-y-6">
            <!-- Task interested container -->
            <div id="task-interested-container" class="bg-white rounded-xl shadow-sm p-6 mb-6 hidden detail-card">
              <h3 class="text-lg font-semibold mb-5 flex items-center">
                <i class="fas fa-user-check text-green-500 mr-3"></i>I'm Interested
              </h3>
              
              <button id="make-offer-btn" class="w-full bg-primary hover:bg-primary-dark text-white px-5 py-3 rounded-xl flex items-center justify-center mb-4 font-medium text-base shadow-sm hover-lift">
                <i class="fas fa-handshake mr-2"></i> Make an Offer
              </button>
              
              <div class="grid grid-cols-2 gap-3">
                <button id="contact-poster-btn" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2.5 rounded-lg flex items-center justify-center hover-lift">
                  <i class="fas fa-comment mr-2"></i> Message
                </button>
                
                <button id="call-poster-btn" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2.5 rounded-lg flex items-center justify-center hover-lift">
                  <i class="fas fa-phone-alt mr-2"></i> Call
                </button>
              </div>
              
              <button id="save-task-btn" class="w-full border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2.5 rounded-lg flex items-center justify-center mt-3 hover-lift">
                <i class="far fa-bookmark mr-2"></i> Save Task
              </button>
            </div>
            
            <!-- Contact Information Card -->
            <div id="contact-info-card" class="bg-white rounded-xl shadow-sm p-6 detail-card">
              <h3 class="text-lg font-semibold mb-5 flex items-center">
                <i class="fas fa-address-card text-blue-500 mr-3"></i>Contact Information
              </h3>
              
              <div id="contact-info-container" class="space-y-5">
                <!-- Phone number -->
                <div id="phone-container" class="flex items-center">
                  <div class="info-icon bg-green-100 text-green-600">
                    <i class="fas fa-phone"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Phone</p>
                    <p id="phone-number" class="font-medium">Not provided</p>
                  </div>
                </div>
                
                <!-- Email -->
                <div id="email-container" class="flex items-center">
                  <div class="info-icon bg-blue-100 text-blue-600">
                    <i class="fas fa-envelope"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Email</p>
                    <p id="email-address" class="font-medium">Not provided</p>
                  </div>
                </div>
                
                <!-- Preferred contact method -->
                <div class="flex items-center">
                  <div class="info-icon bg-purple-100 text-purple-600">
                    <i class="fas fa-star"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Preferred Contact Method</p>
                    <p id="preferred-contact-method" class="font-medium">Platform Messages</p>
                  </div>
                </div>
              </div>
              
              <!-- Contact buttons -->
              <div class="grid grid-cols-2 gap-3 mt-6" id="contact-buttons">
                <button id="message-button" class="bg-primary hover:bg-primary-dark text-white px-4 py-3 rounded-lg flex items-center justify-center font-medium hover-lift">
                  <i class="fas fa-comment mr-2"></i> Message
                </button>
                <button id="call-button" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg flex items-center justify-center font-medium hover-lift">
                  <i class="fas fa-phone-alt mr-2"></i> Call
                </button>
              </div>
            </div>
            
            <!-- Task poster info -->
            <div class="bg-white rounded-xl shadow-sm p-6 detail-card">
              <h3 class="text-lg font-semibold mb-5 flex items-center">
                <i class="fas fa-user text-indigo-500 mr-3"></i>About the Poster
              </h3>
              <div class="flex items-center mb-6">
                <div id="poster-avatar" class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 text-white flex items-center justify-center font-bold text-xl mr-4">
                  P
                </div>
                <div>
                  <p id="poster-name" class="font-semibold text-lg">Task Poster</p>
                  <p id="poster-joined" class="text-sm text-gray-500">Member since</p>
                </div>
              </div>
              
              <div class="border-t border-gray-100 pt-5 space-y-4">
                <div class="flex items-center">
                  <div class="info-icon bg-yellow-100 text-yellow-600 w-10 h-10">
                    <i class="fas fa-star"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Rating</p>
                    <div class="flex items-center">
                      <span id="poster-rating" class="font-medium mr-1">4.8</span>
                      <span id="poster-reviews" class="text-sm text-gray-500">(12 reviews)</span>
                    </div>
                  </div>
                </div>
                
                <div class="flex items-center">
                  <div class="info-icon bg-green-100 text-green-600 w-10 h-10">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Completed Tasks</p>
                    <p id="poster-completed" class="font-medium">8 tasks</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Task summary -->
            <div class="bg-white rounded-xl shadow-sm p-6 detail-card">
              <h3 class="text-lg font-semibold mb-5 flex items-center">
                <i class="fas fa-list-check text-orange-500 mr-3"></i>Task Summary
              </h3>
              <div class="space-y-4">
                <div class="flex items-start">
                  <i class="fas fa-calendar-alt mt-1 mr-3 text-gray-400 w-5 text-center"></i>
                  <div>
                    <p class="text-sm font-medium text-gray-700">Posted On</p>
                    <p class="text-sm text-gray-500" id="summary-posted-date">Recently</p>
                  </div>
                </div>
                
                <div class="flex items-start">
                  <i class="fas fa-clock mt-1 mr-3 text-gray-400 w-5 text-center"></i>
                  <div>
                    <p class="text-sm font-medium text-gray-700">Deadline</p>
                    <p class="text-sm text-gray-500" id="summary-deadline">No deadline set</p>
                  </div>
                </div>
                
                <div class="flex items-start">
                  <i class="fas fa-map-marker-alt mt-1 mr-3 text-gray-400 w-5 text-center"></i>
                  <div>
                    <p class="text-sm font-medium text-gray-700">Location</p>
                    <p class="text-sm text-gray-500" id="summary-location">Location</p>
                  </div>
                </div>
                
                <div class="flex items-start">
                  <i class="fas fa-tag mt-1 mr-3 text-gray-400 w-5 text-center"></i>
                  <div>
                    <p class="text-sm font-medium text-gray-700">Category</p>
                    <p class="text-sm text-gray-500" id="summary-category">Category</p>
                  </div>
                </div>
                
                <div class="flex items-start">
                  <i class="fas fa-rupee-sign mt-1 mr-3 text-gray-400 w-5 text-center"></i>
                  <div>
                    <p class="text-sm font-medium text-gray-700">Budget</p>
                    <p class="text-sm text-gray-500" id="summary-budget">Budget</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Similar tasks -->
            <div class="bg-white rounded-xl shadow-sm p-6 overflow-hidden detail-card">
              <h3 class="text-lg font-semibold mb-5 flex items-center">
                <i class="fas fa-layer-group text-teal-500 mr-3"></i>Similar Tasks
              </h3>
              
              <!-- Similar tasks loading -->
              <div id="similar-tasks-loading" class="py-4">
                <div class="flex items-center animate-pulse mb-4">
                  <div class="w-12 h-12 bg-gray-200 rounded-lg mr-3"></div>
                  <div class="flex-1">
                    <div class="h-4 w-3/4 bg-gray-200 rounded mb-2"></div>
                    <div class="h-3 w-1/2 bg-gray-200 rounded"></div>
                  </div>
                </div>
                <div class="flex items-center animate-pulse mb-4">
                  <div class="w-12 h-12 bg-gray-200 rounded-lg mr-3"></div>
                  <div class="flex-1">
                    <div class="h-4 w-3/4 bg-gray-200 rounded mb-2"></div>
                    <div class="h-3 w-1/2 bg-gray-200 rounded"></div>
                  </div>
                </div>
              </div>
              
              <!-- Similar tasks list -->
              <div id="similar-tasks-list" class="space-y-4 hidden"></div>
              
              <!-- No similar tasks -->
              <div id="no-similar-tasks" class="text-center py-8 hidden">
                <p class="text-gray-500">No similar tasks found</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Chat Icon -->
  <div class="chat-icon">
      <i class="fas fa-comments"></i>
  </div>
  
  <!-- Make offer modal -->
  <div id="offer-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50" id="offer-modal-overlay"></div>
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 z-10">
      <div class="p-6 border-b border-gray-100">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-bold">Make an Offer</h3>
          <button id="close-offer-modal" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <form id="offer-form">
          <div class="mb-4">
            <label for="offer-amount" class="block text-sm font-medium text-gray-700 mb-1">Your Price (₹)</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span class="text-gray-500">₹</span>
              </div>
              <input type="number" id="offer-amount" min="1" class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary" required>
            </div>
          </div>
          
          <div class="mb-6">
            <label for="offer-message" class="block text-sm font-medium text-gray-700 mb-1">Why are you the right person for this task?</label>
            <textarea id="offer-message" rows="4" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Introduce yourself and explain your relevant experience..." required></textarea>
            <p class="text-xs text-gray-500 mt-1">A detailed message increases your chances of getting selected</p>
          </div>
          
          <div class="flex justify-end space-x-3">
            <button type="button" id="close-offer-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
            <button type="submit" class="px-5 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium">Submit Offer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Contact modal -->
  <div id="contact-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50" id="contact-modal-overlay"></div>
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 z-10">
      <div class="p-6 border-b border-gray-100">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-bold">Message Task Poster</h3>
          <button id="close-contact-modal" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <form id="contact-form">
          <div class="mb-6">
            <label for="contact-message" class="block text-sm font-medium text-gray-700 mb-1">Your Message</label>
            <textarea id="contact-message" rows="4" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Type your message here..." required></textarea>
          </div>
          
          <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-contact-btn" class="px-4 py-2 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50">Cancel</button>
            <button type="submit" class="px-5 py-2 bg-primary hover:bg-primary-dark text-white rounded-xl font-medium">Send Message</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Call modal -->
  <div id="call-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50" id="call-modal-overlay"></div>
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 z-10">
      <div class="p-6 border-b border-gray-100">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-bold">Call Task Poster</h3>
          <button id="close-call-modal" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="call-poster-info" class="bg-gray-50 p-5 rounded-xl mb-6">
          <div class="flex items-center">
            <div class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center mr-4">
              <i class="fas fa-phone text-xl"></i>
            </div>
            <div>
              <p id="call-poster-name" class="font-medium text-lg">Task Poster</p>
              <p id="call-poster-phone" class="text-gray-600 font-semibold text-xl">+91 9876543210</p>
            </div>
          </div>
        </div>
        
        <p class="text-gray-600 mb-6">Here's the task poster's phone number. You can call them directly using this number.</p>
        
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancel-call-btn" class="px-4 py-2 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50">Close</button>
          <button id="call-phone-link" class="px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl font-medium transition-colors inline-flex items-center">
            <i class="fas fa-copy mr-2"></i> Copy Number
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="bg-gray-800 text-white py-8">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-4 gap-8">
        <div>
          <a class="text-white font-bold text-2xl flex items-center mb-4" href="index.html">
            <span class="bg-white text-primary p-1 rounded mr-1.5 flex items-center justify-center w-8 h-8">V</span>ictor
          </a>
          <p class="text-gray-300 mb-4">Connecting people for tasks - anytime, anywhere. Get help or help others.</p>
          <div class="flex space-x-4">
            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-twitter"></i></a>
            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-instagram"></i></a>
            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-linkedin-in"></i></a>
          </div>
        </div>
        
        <div>
          <h4 class="font-semibold mb-4 text-lg">For Task Posters</h4>
          <ul class="space-y-2">
            <li><a href="post-task.html" class="text-gray-300 hover:text-white transition-colors">Post a Task</a></li>
            <li><a href="#" class="text-gray-300 hover:text-white transition-colors">How it Works</a></li>
            <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Pricing</a></li>
            <li><a href="#" class="text-gray-300 hover:text-white transition-colors">FAQ</a></li>
          </ul>
        </div>
        
        <div>
          <h4 class="font-semibold mb-4 text-lg">For Task Performers</h4>
          <ul class="space-y-2">
            <li><a href="tasks.html" class="text-gray-300 hover:text-white transition-colors">Browse Tasks</a></li>
            <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Task Categories</a></li>
            <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Earn Money</a></li>
            <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Success Stories</a></li>
          </ul>
        </div>
        
        <div>
          <h4 class="font-semibold mb-4 text-lg">Support</h4>
          <ul class="space-y-2">
            <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Help Center</a></li>
            <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Contact Us</a></li>
            <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Privacy Policy</a></li>
            <li><a href="server-status.html" class="text-gray-300 hover:text-white transition-colors">Server Status</a></li>
          </ul>
        </div>
      </div>
      
      <div class="border-t border-gray-700 mt-8 pt-8 text-center">
        <p class="text-gray-300">© 2023 Victor - Connect for Tasks. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("User data:", {
        token: localStorage.getItem('token') ? "exists" : "missing",
        userId: localStorage.getItem('userId'),
        username: localStorage.getItem('username')
      });
      
      // Get API URL from config
      const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
      
      // Mobile menu toggle
      document.getElementById('mobile-menu-button').addEventListener('click', function() {
        document.getElementById('mobile-menu').classList.toggle('hidden');
      });
      
      // Check if user is logged in
      checkLoginStatus();
      
      // Setup user dropdown toggle
      setupUserDropdown();
      
      // Setup notifications dropdown toggle
      setupNotificationsDropdown();
      
      // Get task ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const taskId = urlParams.get('id');
      
      if (!taskId) {
        showErrorState("No task ID provided");
        return;
      }
      
      // Load task details
      loadTaskDetails(taskId);
      
      // Setup modal functionality
      setupModals();
    });
    
    // Check login status and update UI accordingly
    function checkLoginStatus() {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');
      const userEmail = localStorage.getItem('userEmail');
      const userId = localStorage.getItem('userId');
      
      const authButtons = document.getElementById('auth-buttons');
      const userMenuContainer = document.getElementById('user-menu-container');
      const mobileAuthLinks = document.getElementById('mobile-auth-links');
      const mobileUserLinks = document.getElementById('mobile-user-links');
      
      if (token && userId) {
        // User is logged in
        if (authButtons) authButtons.classList.add('hidden');
        if (userMenuContainer) userMenuContainer.classList.remove('hidden');
        if (mobileAuthLinks) mobileAuthLinks.classList.add('hidden');
        if (mobileUserLinks) mobileUserLinks.classList.remove('hidden');
        
        // Update user info
        const usernameDisplay = document.getElementById('username-display');
        const userNameDropdown = document.getElementById('user-name-dropdown');
        const userEmailDropdown = document.getElementById('user-email-dropdown');
        const userAvatar = document.getElementById('user-avatar');
        
        if (usernameDisplay && username) usernameDisplay.textContent = username;
        if (userNameDropdown && username) userNameDropdown.textContent = username;
        if (userEmailDropdown && userEmail) userEmailDropdown.textContent = userEmail;
        if (userAvatar && username) userAvatar.textContent = username.charAt(0).toUpperCase();
        
        // Setup logout buttons
        const logoutButton = document.getElementById('logout-button');
        const mobileLogoutButton = document.getElementById('mobile-logout-button');
        
        if (logoutButton) {
          logoutButton.addEventListener('click', function(e) {
            e.preventDefault();
            logout();
          });
        }
        
        if (mobileLogoutButton) {
          mobileLogoutButton.addEventListener('click', function(e) {
            e.preventDefault();
            logout();
          });
        }
      } else {
        // User is not logged in
        if (authButtons) authButtons.classList.remove('hidden');
        if (userMenuContainer) userMenuContainer.classList.add('hidden');
        if (mobileAuthLinks) mobileAuthLinks.classList.remove('hidden');
        if (mobileUserLinks) mobileUserLinks.classList.add('hidden');
      }
      
      return token && userId;
    }
    
    // Setup user dropdown
    function setupUserDropdown() {
      const userMenuButton = document.getElementById('user-menu-button');
      const userDropdown = document.getElementById('user-dropdown');
      
      if (userMenuButton && userDropdown) {
        userMenuButton.addEventListener('click', function(e) {
          e.stopPropagation();
          userDropdown.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
          if (!userMenuButton.contains(event.target) && !userDropdown.contains(event.target)) {
            userDropdown.classList.add('hidden');
          }
        });
      }
    }
    
    // Setup notifications dropdown
    function setupNotificationsDropdown() {
      const notificationsButton = document.getElementById('notifications-button');
      const notificationsDropdown = document.getElementById('notifications-dropdown');
      
      if (notificationsButton && notificationsDropdown) {
        notificationsButton.addEventListener('click', function(e) {
          e.stopPropagation();
          notificationsDropdown.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
          if (!notificationsButton.contains(event.target) && !notificationsDropdown.contains(event.target)) {
            notificationsDropdown.classList.add('hidden');
          }
        });
      }
    }
    
    // Setup modals (Offer, Contact, Call)
    function setupModals() {
      // Offer modal
      const offerModal = document.getElementById('offer-modal');
      const offerBtn = document.getElementById('make-offer-btn');
      const closeOfferModal = document.getElementById('close-offer-modal');
      const offerModalOverlay = document.getElementById('offer-modal-overlay');
      const offerForm = document.getElementById('offer-form');
      
      if (offerBtn) {
        offerBtn.addEventListener('click', function() {
          offerModal.classList.remove('hidden');
        });
      }
      
      if (closeOfferModal) {
        closeOfferModal.addEventListener('click', function() {
          offerModal.classList.add('hidden');
        });
      }
      
      if (offerModalOverlay) {
        offerModalOverlay.addEventListener('click', function() {
          offerModal.classList.add('hidden');
        });
      }
      
      if (offerForm) {
        offerForm.addEventListener('submit', function(e) {
          e.preventDefault();
          submitOffer();
        });
      }
      
      // Contact modal
      const contactModal = document.getElementById('contact-modal');
      const contactBtn = document.getElementById('contact-poster-btn');
      const closeContactModal = document.getElementById('close-contact-modal');
      const contactModalOverlay = document.getElementById('contact-modal-overlay');
      const contactForm = document.getElementById('contact-form');
      
      if (contactBtn) {
        contactBtn.addEventListener('click', function() {
          contactModal.classList.remove('hidden');
        });
      }
      
      if (closeContactModal) {
        closeContactModal.addEventListener('click', function() {
          contactModal.classList.add('hidden');
        });
      }
      
      if (contactModalOverlay) {
        contactModalOverlay.addEventListener('click', function() {
          contactModal.classList.add('hidden');
        });
      }
      
      if (contactForm) {
        contactForm.addEventListener('submit', function(e) {
          e.preventDefault();
          submitContactForm();
        });
      }
      
      // Call modal
      const callModal = document.getElementById('call-modal');
      const callBtn = document.getElementById('call-poster-btn');
      const closeCallModal = document.getElementById('close-call-modal');
      const callModalOverlay = document.getElementById('call-modal-overlay');
      
      if (callBtn) {
        callBtn.addEventListener('click', function() {
          const phoneNumber = callBtn.getAttribute('data-phone');
          const posterName = callBtn.getAttribute('data-name') || 'Task Poster';
          showCallModal(phoneNumber, posterName);
        });
      }
      
      if (closeCallModal) {
        closeCallModal.addEventListener('click', function() {
          callModal.classList.add('hidden');
        });
      }
      
      if (callModalOverlay) {
        callModalOverlay.addEventListener('click', function() {
          callModal.classList.add('hidden');
        });
      }
    }
    
    // Load task details from API
    async function loadTaskDetails(taskId) {
      try {
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        
        console.log('Loading task with ID:', taskId);
        
        // Fetch task data
        const response = await fetch(`${API_URL}/api/tasks/${taskId}`);
        
        if (!response.ok) {
          const errorData = await response.json().catch(e => ({ message: `HTTP error: ${response.status}` }));
          throw new Error(errorData.message || `Failed to load task: ${response.status}`);
        }
        
        const task = await response.json();
        console.log('Task loaded:', task);
        
        // If task doesn't have an id, use the _id property if available
        if (!task.id && task._id) {
          task.id = task._id;
        }
        
        // Check if task exists
        if (!task || (!task.id && !task._id)) {
          throw new Error('Invalid task data returned from the server');
        }
        
        // Hide loading, show task details
        document.getElementById('loading-container').classList.add('hidden');
        document.getElementById('task-details').classList.remove('hidden');
        
        // Populate task details
        populateTaskDetails(task);
        
        // Check if user is the task poster
        const currentUserId = localStorage.getItem('userId');
        const isTaskPoster = currentUserId && (task.userId == currentUserId || task.createdBy == currentUserId);
        
        // Show appropriate action buttons based on user role and task status
        updateActionButtons(task, isTaskPoster);
        
        // Load similar tasks
        loadSimilarTasks(task.category, taskId);
        
        // Load offers if user is the task poster
        if (isTaskPoster) {
          loadOffers(taskId);
        }
        
      } catch (error) {
        console.error('Error loading task details:', error);
        showErrorState(error.message || 'Failed to load task details');
      }
    }
    
    // Populate task details in the UI
    function populateTaskDetails(task) {
      // Main task info
      document.getElementById('task-title').textContent = task.title;
      document.getElementById('task-description').innerHTML = task.description || 'No description provided';
      document.getElementById('task-category').textContent = task.category || 'Uncategorized';
      document.getElementById('task-location').textContent = task.location || 'Remote';
      document.getElementById('task-budget').textContent = task.budget ? `₹${task.budget}` : 'Negotiable';
      
      // Update task status banner
      const taskStatusBanner = document.getElementById('task-status-banner');
      const taskStatusText = document.getElementById('task-status-text');
      
      if (task.status === 'Open') {
        if (taskStatusBanner) taskStatusBanner.className = 'py-3 px-6 bg-green-50 text-green-700 flex items-center justify-between';
        if (taskStatusText) taskStatusText.innerHTML = '<i class="fas fa-door-open mr-2"></i>Open for offers';
      } else if (task.status === 'In Progress') {
        if (taskStatusBanner) taskStatusBanner.className = 'py-3 px-6 bg-yellow-50 text-yellow-700 flex items-center justify-between';
        if (taskStatusText) taskStatusText.innerHTML = '<i class="fas fa-spinner mr-2"></i>In Progress';
      } else {
        if (taskStatusBanner) taskStatusBanner.className = 'py-3 px-6 bg-blue-50 text-blue-700 flex items-center justify-between';
        if (taskStatusText) taskStatusText.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Completed';
      }
      
      // Status badge (if it exists)
      const taskStatus = document.getElementById('task-status');
      if (taskStatus) {
        const statusClasses = {
          'Open': 'bg-green-50 text-green-600',
          'In Progress': 'bg-yellow-50 text-yellow-600',
          'Completed': 'bg-gray-50 text-gray-600'
        };
        const statusIcons = {
          'Open': 'fa-circle',
          'In Progress': 'fa-spinner',
          'Completed': 'fa-check-circle'
        };
        
        taskStatus.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClasses[task.status] || 'bg-gray-50 text-gray-600'}`;
        taskStatus.innerHTML = `<i class="fas ${statusIcons[task.status] || 'fa-circle'} text-xs mr-1.5"></i>${task.status}`;
      }
      
      // Check if task is urgent and update UI
      if (task.urgent) {
        const urgentBadge = document.getElementById('task-urgent-badge');
        if (urgentBadge) urgentBadge.classList.remove('hidden');
        
        const deadlineUrgency = document.getElementById('deadline-urgency');
        if (deadlineUrgency) {
          deadlineUrgency.classList.remove('hidden');
          document.getElementById('deadline-details').classList.remove('hidden');
        }
      }
      
      // Dates
      const postedDate = TaskUtils.formatDate(task.createdAt, true);
      if (document.getElementById('task-posted-date')) document.getElementById('task-posted-date').textContent = postedDate;
      if (document.getElementById('summary-posted-date')) document.getElementById('summary-posted-date').textContent = postedDate;
      
      // Deadline
      if (task.deadline) {
        const formattedDeadline = TaskUtils.formatDate(task.deadline);
        if (document.getElementById('summary-deadline')) document.getElementById('summary-deadline').textContent = formattedDeadline;
        if (document.getElementById('deadline-display')) {
          document.getElementById('deadline-display').textContent = formattedDeadline;
          document.getElementById('deadline-details').classList.remove('hidden');
        }
      } else {
        if (document.getElementById('summary-deadline')) document.getElementById('summary-deadline').textContent = 'No deadline set';
      }
      
      // Summary section
      if (document.getElementById('summary-location')) document.getElementById('summary-location').textContent = task.location || 'Remote';
      if (document.getElementById('summary-category')) document.getElementById('summary-category').textContent = task.category || 'Uncategorized';
      if (document.getElementById('summary-budget')) document.getElementById('summary-budget').textContent = task.budget ? `₹${task.budget}` : 'Negotiable';
      
      // Set breadcrumb title
      if (document.getElementById('breadcrumb-title')) document.getElementById('breadcrumb-title').textContent = task.title;
      
      // Task poster info
      fetchUserDetails(task.userId);
      
      // Handle location details
      handleLocationDisplay(task);
      
      // Handle contact details
      handleContactDetails(task);
    }
    
    // New function to handle location display
    function handleLocationDisplay(task) {
      const locationDetailsSection = document.getElementById('location-details');
      
      // If remote task, hide location section
      if (!task.location || task.location === 'Remote') {
        locationDetailsSection.classList.add('hidden');
        return;
      }
      
      // Show location section for non-remote tasks
      locationDetailsSection.classList.remove('hidden');
      
      // Update location name
      document.getElementById('location-display-name').textContent = task.location;
      
      // Update specific location if available
      const specificLocationEl = document.getElementById('specific-location-display');
      if (task.specificLocation) {
        specificLocationEl.textContent = task.specificLocation;
        specificLocationEl.classList.remove('hidden');
      } else {
        specificLocationEl.classList.add('hidden');
      }
      
      // Update map placeholder with location info
      document.getElementById('map-placeholder').innerHTML = `
        <i class="fas fa-map-marked-alt text-gray-400 mr-2 text-2xl"></i>
        Location: ${task.location}${task.specificLocation ? ` - ${task.specificLocation}` : ''}
      `;
    }
    
    // New function to handle contact details display
    function handleContactDetails(task) {
      const contactInfoCard = document.getElementById('contact-info-card');
      const phoneContainer = document.getElementById('phone-container');
      const emailContainer = document.getElementById('email-container');
      const callButton = document.getElementById('call-button');
      
      // Check if contact details exist
      if (!task.contactDetails) {
        contactInfoCard.classList.add('hidden');
        return;
      }
      
      contactInfoCard.classList.remove('hidden');
      
      // Handle phone number
      if (task.contactDetails.phone) {
        phoneContainer.classList.remove('hidden');
        document.getElementById('phone-number').textContent = task.contactDetails.phone;
        
        // Update call button
        callButton.classList.remove('hidden');
        callButton.addEventListener('click', function() {
          showCallModal(task.contactDetails.phone, task.createdBy || 'Task Poster');
        });
        
        // Also update the call-poster-btn if it exists
        const callPosterBtn = document.getElementById('call-poster-btn');
        if (callPosterBtn) {
          // Set data attributes for the phone number and name
          callPosterBtn.setAttribute('data-phone', task.contactDetails.phone);
          callPosterBtn.setAttribute('data-name', task.createdBy || 'Task Poster');
          
          callPosterBtn.addEventListener('click', function() {
            showCallModal(task.contactDetails.phone, task.createdBy || 'Task Poster');
          });
        }
      } else {
        phoneContainer.classList.add('hidden');
        callButton.classList.add('hidden');
        
        // Hide call-poster-btn if no phone number
        const callPosterBtn = document.getElementById('call-poster-btn');
        if (callPosterBtn) {
          callPosterBtn.classList.add('hidden');
        }
      }
      
      // Handle email
      if (task.contactDetails.email) {
        emailContainer.classList.remove('hidden');
        document.getElementById('email-address').textContent = task.contactDetails.email;
      } else {
        emailContainer.classList.add('hidden');
      }
      
      // Handle preferred contact method
      const preferredMethodElement = document.getElementById('preferred-contact-method');
      if (preferredMethodElement) {
        if (task.contactDetails.preferredMethod === 'phone') {
          preferredMethodElement.textContent = 'Phone Call';
        } else if (task.contactDetails.preferredMethod === 'email') {
          preferredMethodElement.textContent = 'Email';
        } else {
          preferredMethodElement.textContent = 'Platform Messages';
        }
      }
      
      // Setup message button
      const messageButton = document.getElementById('message-button');
      if (messageButton) {
        messageButton.addEventListener('click', function() {
          document.getElementById('contact-modal').classList.remove('hidden');
        });
        
        // Store poster ID for contact form submission
        const contactPosterBtn = document.getElementById('contact-poster-btn');
        if (contactPosterBtn) {
          contactPosterBtn.setAttribute('data-poster-id', task.userId);
        }
      }
    }
    
    // Show call modal with provided phone number
    function showCallModal(phoneNumber, posterName) {
      const callModal = document.getElementById('call-modal');
      const callPosterPhone = document.getElementById('call-poster-phone');
      const callPosterName = document.getElementById('call-poster-name');
      const callPhoneLink = document.getElementById('call-phone-link');
      
      if (callPosterPhone) callPosterPhone.textContent = phoneNumber || 'Not provided';
      if (callPosterName) callPosterName.textContent = posterName || 'Task Poster';
      
      // Change: Remove the tel: link functionality and just make it a button
      if (callPhoneLink) {
        callPhoneLink.removeAttribute('href');
        callPhoneLink.classList.add('cursor-pointer');
      }
      
      callModal.classList.remove('hidden');
    }
    
    // Update action buttons based on user role and task status - More streamlined
    function updateActionButtons(task, isTaskPoster) {
      const taskActionsContainer = document.getElementById('task-actions');
      const taskInterestedContainer = document.getElementById('task-interested-container');
      
      if (!taskActionsContainer) return;
      
      // Clear any existing content
      taskActionsContainer.innerHTML = '';
      
      // User is the task poster
      if (isTaskPoster) {
        // Show different options based on task status
        if (task.status === 'Open') {
          taskActionsContainer.innerHTML = `
            <h3 class="text-lg font-semibold mb-4">Manage Task</h3>
            <div class="flex flex-wrap gap-3">
              <button id="edit-task-btn" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg inline-flex items-center">
                <i class="fas fa-edit mr-2"></i> Edit Task
              </button>
              <button id="view-offers-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg inline-flex items-center">
                <i class="fas fa-handshake mr-2"></i> View Offers
              </button>
              <button id="delete-task-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg inline-flex items-center">
                <i class="fas fa-trash-alt mr-2"></i> Delete Task
              </button>
            </div>
          `;
          
          // Add event listeners
          document.getElementById('edit-task-btn').addEventListener('click', () => {
            window.location.href = `edit-task.html?id=${task.id}`;
          });
          
          document.getElementById('delete-task-btn').addEventListener('click', () => {
            confirmDeleteTask(task.id);
          });
          
          document.getElementById('view-offers-btn').addEventListener('click', () => {
            toggleOffersVisibility();
          });
        } 
        else if (task.status === 'In Progress') {
          taskActionsContainer.innerHTML = `
            <h3 class="text-lg font-semibold mb-4">Task Actions</h3>
            <div class="flex flex-wrap gap-3">
              <button id="mark-complete-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg inline-flex items-center">
                <i class="fas fa-check-circle mr-2"></i> Mark as Complete
              </button>
              <button id="cancel-task-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg inline-flex items-center">
                <i class="fas fa-times-circle mr-2"></i> Cancel Task
              </button>
            </div>
          `;
          
          // Add event listeners
          document.getElementById('mark-complete-btn').addEventListener('click', () => {
            updateTaskStatus(task.id, 'Completed');
          });
          
          document.getElementById('cancel-task-btn').addEventListener('click', () => {
            confirmCancelTask(task.id);
          });
        }
        else if (task.status === 'Completed') {
          taskActionsContainer.innerHTML = `
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Task Completed</h3>
              <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium flex items-center">
                <i class="fas fa-check-circle mr-1"></i> Completed on ${TaskUtils.formatDate(task.completedAt || task.updatedAt)}
              </span>
            </div>
            <p class="text-gray-600 mt-2">This task has been marked as completed. Thank you for using Victor!</p>
            <div class="mt-4">
              <button id="reopen-task-btn" class="text-primary hover:underline inline-flex items-center">
                <i class="fas fa-redo mr-1"></i> Reopen Task
              </button>
            </div>
          `;
          
          // Add event listener
          document.getElementById('reopen-task-btn').addEventListener('click', () => {
            updateTaskStatus(task.id, 'Open');
          });
        }
        
        // Hide the interested container for task posters
        if (taskInterestedContainer) {
          taskInterestedContainer.classList.add('hidden');
        }
      }
      // User is not the task poster
      else {
        const isLoggedIn = checkLoginStatus();
        
        // For non-posters, hide the actions container
        taskActionsContainer.classList.add('hidden');
        
        // Show the interested container if task is open and user is logged in
        if (taskInterestedContainer && isLoggedIn && task.status === 'Open') {
          taskInterestedContainer.classList.remove('hidden');
        }
      }
    }
    
    // Fetch user details for the task poster
    async function fetchUserDetails(userId) {
      try {
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        
        // Fetch user data
        const response = await fetch(`${API_URL}/api/users/${userId}`);
        
        if (!response.ok) {
          throw new Error(`Failed to load user details: ${response.status}`);
        }
        
        const user = await response.json();
        
        // Update UI with user details
        document.getElementById('poster-name').textContent = user.username || 'User';
        
        const joinedDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'Recently';
        document.getElementById('poster-joined').textContent = `Member since ${joinedDate}`;
        
        // Update ratings if available
        if (user.rating) {
          document.getElementById('poster-rating').textContent = user.rating.toFixed(1);
          document.getElementById('poster-reviews').textContent = `(${user.reviewCount || 0} reviews)`;
        }
        
        // Update tasks completed if available
        if (user.completedTasks) {
          document.getElementById('poster-completed').textContent = `${user.completedTasks} tasks completed`;
        }
        
        // Update avatar if available
        const posterAvatar = document.getElementById('poster-avatar');
        if (posterAvatar) {
          if (user.profileImage) {
            posterAvatar.innerHTML = `<img src="${user.profileImage}" alt="${user.username}" class="w-full h-full object-cover rounded-full">`;
          } else {
            posterAvatar.innerHTML = `<span class="text-2xl font-bold">${(user.username || 'U').charAt(0).toUpperCase()}</span>`;
            posterAvatar.classList.add('bg-gradient-to-tr', 'from-purple-400', 'to-blue-500', 'text-white');
          }
        }
        
      } catch (error) {
        console.error('Error loading user details:', error);
        // Don't show error state, just leave default values
      }
    }
    
    // Load similar tasks
    async function loadSimilarTasks(category, currentTaskId) {
      try {
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        
        // Fetch tasks with the same category
        const response = await fetch(`${API_URL}/api/tasks?category=${encodeURIComponent(category)}`);
        
        if (!response.ok) {
          throw new Error(`Failed to load similar tasks: ${response.status}`);
        }
        
        let tasks = await response.json();
        
        // Filter out the current task and keep only open tasks
        tasks = tasks.filter(task => task.id != currentTaskId && task.status === 'Open');
        
        // Show up to 3 similar tasks
        tasks = tasks.slice(0, 3);
        
        // Hide loading state
        document.getElementById('similar-tasks-loading').classList.add('hidden');
        
        // Show empty state if no similar tasks
        if (tasks.length === 0) {
          document.getElementById('no-similar-tasks').classList.remove('hidden');
          return;
        }
        
        // Show similar tasks
        const similarTasksList = document.getElementById('similar-tasks-list');
        similarTasksList.classList.remove('hidden');
        
        // Create task list items
        tasks.forEach(task => {
          const taskItem = document.createElement('div');
          taskItem.className = 'flex items-start hover:bg-gray-50 p-2 rounded-lg transition-colors';
          
          const formattedDate = TaskUtils.formatDate(task.createdAt, true);
          
          taskItem.innerHTML = `
            <div class="mr-3 flex-shrink-0">
              <div class="w-12 h-12 rounded bg-primary-light flex items-center justify-center">
                <i class="fas fa-clipboard-list text-primary"></i>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <a href="task-detail.html?id=${task.id}" class="text-sm font-medium line-clamp-1 hover:text-primary">${task.title}</a>
              <p class="text-xs text-gray-500 mb-1">${formattedDate} • ${task.location || 'Remote'}</p>
              <p class="text-xs text-gray-500 font-medium">${task.budget ? `₹${task.budget}` : 'Negotiable'}</p>
            </div>
          `;
          
          similarTasksList.appendChild(taskItem);
        });
        
      } catch (error) {
        console.error('Error loading similar tasks:', error);
        
        // Show error state
        const similarTasksContainer = document.getElementById('similar-tasks-list');
        if (similarTasksContainer) {
          similarTasksContainer.innerHTML = `
            <div class="text-center py-3">
              <p class="text-gray-500">Failed to load similar tasks</p>
            </div>
          `;
          similarTasksContainer.classList.remove('hidden');
        }
        document.getElementById('similar-tasks-loading').classList.add('hidden');
      }
    }
    
    // Load offers for the task (only for task poster)
    async function loadOffers(taskId) {
      try {
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        const token = localStorage.getItem('token');
        
        if (!token) return;
        
        // Fetch offers data
        const response = await fetch(`${API_URL}/api/tasks/${taskId}/offers`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Failed to load offers: ${response.status}`);
        }
        
        const offers = await response.json();
        
        const offersContainer = document.getElementById('offers-container');
        const offersList = document.getElementById('offers-list');
        const noOffers = document.getElementById('no-offers');
        
        if (!offersContainer || !offersList || !noOffers) return;
        
        // Show offers container
        offersContainer.classList.remove('hidden');
        
        // Show empty state if no offers
        if (!offers || offers.length === 0) {
          offersList.classList.add('hidden');
          noOffers.classList.remove('hidden');
          return;
        }
        
        // Show offers list
        offersList.innerHTML = '';
        noOffers.classList.add('hidden');
        offersList.classList.remove('hidden');
        
        // Sort offers by date (newest first)
        offers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        // Render offers
        offers.forEach(offer => {
          const offerElement = createOfferElement(offer, taskId);
          offersList.appendChild(offerElement);
        });
        
      } catch (error) {
        console.error('Error loading offers:', error);
      }
    }
    
    // Create offer element - Simplified and focused on accept button
    function createOfferElement(offer, taskId) {
      const div = document.createElement('div');
      div.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow';
      
      const createdDate = TaskUtils.formatDate(offer.createdAt, true);
      
      div.innerHTML = `
        <div class="flex items-start">
          <div class="mr-3">
            <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-blue-400 to-indigo-500 text-white flex items-center justify-center font-bold">
              ${offer.userUsername ? offer.userUsername.charAt(0).toUpperCase() : 'U'}
            </div>
          </div>
          <div class="flex-1">
            <div class="flex flex-wrap justify-between mb-2">
              <div>
                <span class="font-medium">${offer.userUsername || 'Anonymous'}</span>
                <span class="text-gray-500 text-sm ml-2">offered ${createdDate}</span>
              </div>
              <div class="font-semibold text-green-600">₹${offer.amount}</div>
            </div>
            <p class="text-gray-700 mb-4">${offer.message}</p>
            
            <div class="flex flex-wrap gap-2 mt-2">
              <button class="accept-offer-btn px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm inline-flex items-center font-medium shadow-sm" data-offer-id="${offer.id}">
                <i class="fas fa-check-circle mr-1"></i> Accept Offer
              </button>
              <button class="message-user-btn px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm inline-flex items-center" data-user-id="${offer.userId}">
                <i class="fas fa-comment mr-1"></i> Message
              </button>
              <button class="decline-offer-btn px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm inline-flex items-center" data-offer-id="${offer.id}">
                <i class="fas fa-times-circle mr-1"></i> Decline
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Add event listeners
      setTimeout(() => {
        const acceptBtn = div.querySelector('.accept-offer-btn');
        const declineBtn = div.querySelector('.decline-offer-btn');
        const messageBtn = div.querySelector('.message-user-btn');
        
        if (acceptBtn) {
          acceptBtn.addEventListener('click', function() {
            const offerId = this.getAttribute('data-offer-id');
            acceptOffer(taskId, offerId);
          });
        }
        
        if (declineBtn) {
          declineBtn.addEventListener('click', function() {
            const offerId = this.getAttribute('data-offer-id');
            declineOffer(taskId, offerId);
          });
        }
        
        if (messageBtn) {
          messageBtn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            messageUser(userId);
          });
        }
      }, 0);
      
      return div;
    }
    
    // Accept an offer
    async function acceptOffer(taskId, offerId) {
      if (!confirm('Are you sure you want to accept this offer? This will assign the task to this user.')) {
        return;
      }
      
      try {
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        const token = localStorage.getItem('token');
        
        if (!token) {
          alert('You must be logged in to accept offers.');
          return;
        }
        
        // Send accept request to server
        const response = await fetch(`${API_URL}/api/tasks/${taskId}/offers/${offerId}/accept`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to accept offer');
        }
        
        // Reload the page to reflect changes
        window.location.reload();
        
      } catch (error) {
        console.error('Error accepting offer:', error);
        alert('Failed to accept offer. Please try again.');
      }
    }
    
    // Decline an offer
    async function declineOffer(taskId, offerId) {
      if (!confirm('Are you sure you want to decline this offer?')) {
        return;
      }
      
      try {
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        const token = localStorage.getItem('token');
        
        if (!token) {
          alert('You must be logged in to decline offers.');
          return;
        }
        
        // Send decline request to server
        const response = await fetch(`${API_URL}/api/tasks/${taskId}/offers/${offerId}/decline`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to decline offer');
        }
        
        // Reload offers
        loadOffers(taskId);
        
      } catch (error) {
        console.error('Error declining offer:', error);
        alert('Failed to decline offer. Please try again.');
      }
    }
    
    // Message a user
    function messageUser(userId) {
      // For now, just open the contact modal
      document.getElementById('contact-modal').classList.remove('hidden');
    }
    
    // Submit an offer
    async function submitOffer() {
      try {
        const amount = document.getElementById('offer-amount').value.trim();
        const message = document.getElementById('offer-message').value.trim();
        
        if (!amount) {
          alert('Please enter an offer amount.');
          return;
        }
        
        if (isNaN(parseInt(amount, 10))) {
          alert('Please enter a valid numeric amount.');
          return;
        }
        
        if (!message) {
          alert('Please enter a message.');
          return;
        }
        
        // Get submit button and store its text
        const submitBtn = document.querySelector('#offer-form button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
        
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        const token = localStorage.getItem('token');
        
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          const taskId = urlParams.get('id');
          window.location.href = 'login.html?redirect=task-detail.html?id=' + taskId;
          return;
        }
        
        // Get task ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('id');
        
        if (!taskId) {
          throw new Error('Task ID not found');
        }
        
        // Get task details to find the poster ID
        const taskResponse = await fetch(`${API_URL}/api/tasks/${taskId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!taskResponse.ok) {
          throw new Error('Failed to get task details');
        }
        
        const taskData = await taskResponse.json();
        const posterId = taskData.userId;
        const taskTitle = taskData.title || 'Unknown Task';
        
        if (!posterId) {
          throw new Error('Could not identify task poster');
        }
        
        // First create/get chat with the task poster
        console.log(`Creating chat for task ${taskId} with poster ${posterId}`);
        const chatResponse = await fetch(`${API_URL}/api/chats/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            taskId: taskId,
            recipientId: posterId
          })
        });
        
        let chatId = null;
        
        if (chatResponse.ok) {
          const chatData = await chatResponse.json();
          chatId = chatData.chatId || chatData._id;
          console.log('Created chat with ID:', chatId);
          
          if (chatId) {
            // Format offer message with better formatting
            const offerMessage = `I am offering ₹${amount} for this task: ${message}`;
            
            try {
              // Send message with complete information
              const messageResponse = await fetch(`${API_URL}/api/chats/${chatId}/messages`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  content: offerMessage,
                  taskId: taskId,
                  taskTitle: taskTitle,
                  recipientId: posterId,
                  recipientName: taskData.createdBy || 'Task Poster'
                })
              });
              
              if (!messageResponse.ok) {
                console.error('Failed to send message with offer details');
              } else {
                const messageData = await messageResponse.json();
                console.log('Message sent successfully with offer details:', messageData);
              }
            } catch (messageError) {
              console.error('Error sending offer message:', messageError);
            }
          }
        } else {
          console.error('Failed to create chat, continuing with offer submission');
        }
        
        // Send offer to server
        const offerResponse = await fetch(`${API_URL}/api/tasks/${taskId}/offers`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            amount: parseInt(amount, 10),
            message: message
          })
        });
        
        if (!offerResponse.ok) {
          const errorData = await offerResponse.json().catch(e => ({ message: `HTTP error: ${offerResponse.status}` }));
          throw new Error(errorData.message || 'Failed to submit offer');
        }
        
        const data = await offerResponse.json();
        console.log('Offer submitted successfully:', data);
        
        // Close modal and clear form
        document.getElementById('offer-modal').classList.add('hidden');
        document.getElementById('offer-amount').value = '';
        document.getElementById('offer-message').value = '';
        
        // Show success message with option to go to messages
        Swal.fire({
          title: 'Offer Submitted!',
          text: 'Your offer has been sent. Would you like to view your conversation with the task poster?',
          icon: 'success',
          showCancelButton: true,
          confirmButtonText: 'Go to Messages',
          cancelButtonText: 'Stay Here'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = chatId ? `chat.html?id=${chatId}` : 'messages.html';
          }
        });
        
      } catch (error) {
        console.error('Error submitting offer:', error);
        alert(error.message || 'Failed to submit offer. Please try again.');
      } finally {
        // Restore button state
        const submitBtn = document.querySelector('#offer-form button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText || 'Submit Offer';
        }
      }
    }
    
    // Submit contact form
    async function submitContactForm() {
      try {
        const message = document.getElementById('contact-message').value.trim();
        
        if (!message) {
          alert('Please enter a message.');
          return;
        }
        
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        const token = localStorage.getItem('token');
        
        if (!token) {
          alert('You must be logged in to contact the poster.');
          return;
        }
        
        // Get task ID and poster ID
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('id');
        const posterId = document.getElementById('contact-poster-btn').getAttribute('data-poster-id');
        
        if (!taskId || !posterId) {
          throw new Error('Missing task or poster information');
        }
        
        // Show loading state
        const submitBtn = document.querySelector('#contact-form button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
        
        // 1. Create chat if it doesn't exist
        console.log(`Creating or getting chat for task ${taskId} with poster ${posterId}`);
        const chatResponse = await fetch(`${API_URL}/api/chats/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            taskId: taskId,
            recipientId: posterId
          })
        });
        
        if (!chatResponse.ok) {
          const errorText = await chatResponse.text();
          console.error('Chat creation error:', errorText);
          throw new Error('Failed to create chat');
        }
        
        const chatData = await chatResponse.json();
        const chatId = chatData.chatId || chatData._id;
        console.log('Chat created/retrieved with ID:', chatId);
        
        if (!chatId) {
          throw new Error('Invalid chat data returned from server');
        }
        
        // 2. Get task details for reference 
        const taskResponse = await fetch(`${API_URL}/api/tasks/${taskId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!taskResponse.ok) {
          throw new Error('Failed to get task details');
        }
        
        const taskData = await taskResponse.json();
        const taskTitle = taskData.title || 'Unknown Task';
        const posterName = taskData.createdBy || 'Task Poster';
        
        // 3. Send the message with all required information
        const messageResponse = await fetch(`${API_URL}/api/chats/${chatId}/messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            content: message,
            taskId: taskId,
            taskTitle: taskTitle,
            recipientId: posterId,
            recipientName: posterName
          })
        });
        
        if (!messageResponse.ok) {
          console.error('Message sending failed with status:', messageResponse.status);
          const errorText = await messageResponse.text().catch(() => 'Unknown error');
          console.error('Error details:', errorText);
          throw new Error('Failed to send message');
        }
        
        console.log('Message sent successfully');
        
        // 4. Send a notification
        try {
          await fetch(`${API_URL}/api/notifications/send`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              recipientId: posterId,
              type: 'message',
              message: 'You received a new message about a task',
              taskId: taskId,
              chatId: chatId
            })
          });
        } catch (notifError) {
          console.error('Failed to send notification:', notifError);
          // Continue with success flow even if notification fails
        }
        
        // Close modal and clear form
        document.getElementById('contact-modal').classList.add('hidden');
        document.getElementById('contact-message').value = '';
        
        // Show success message and redirect option
        Swal.fire({
          title: 'Message Sent!',
          text: 'You will be redirected to the conversation',
          icon: 'success',
          showCancelButton: true,
          confirmButtonText: 'Go to Chat',
          cancelButtonText: 'Stay Here'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = `chat.html?id=${chatId}`;
          }
        });
      } catch (error) {
        console.error('Error in submitContactForm:', error);
        alert(error.message || 'Failed to send message. Please try again.');
      } finally {
        // Restore button state
        const submitBtn = document.querySelector('#contact-form button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText || 'Send Message';
        }
      }
    }
    
    // Toggle visibility of offers section
    function toggleOffersVisibility() {
      const offersContainer = document.getElementById('offers-container');
      
      if (offersContainer) {
        offersContainer.classList.toggle('hidden');
        
        // If now visible, make sure to update the offers list
        if (!offersContainer.classList.contains('hidden')) {
          // Get task ID from URL
          const urlParams = new URLSearchParams(window.location.search);
          const taskId = urlParams.get('id');
          
          if (taskId) {
            loadOffers(taskId);
          }
        }
      }
    }
    
    // Show error state
    function showErrorState(message) {
      const loadingContainer = document.getElementById('loading-container');
      const errorContainer = document.getElementById('error-container');
      const taskDetails = document.getElementById('task-details');
      
      if (loadingContainer) loadingContainer.classList.add('hidden');
      if (errorContainer) {
        errorContainer.classList.remove('hidden');
        const errorMessage = errorContainer.querySelector('p');
        if (errorMessage && message) {
          errorMessage.textContent = message;
        }
      }
      if (taskDetails) taskDetails.classList.add('hidden');
      
      console.error('Error showing task details:', message);
    }
    
    // Update task status
    async function updateTaskStatus(taskId, newStatus) {
      if (!confirm(`Are you sure you want to mark this task as ${newStatus}?`)) {
        return;
      }
      
      try {
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        const token = localStorage.getItem('token');
        
        if (!token) {
          alert('You must be logged in to update task status.');
          return;
        }
        
        // Send update request to server
        const response = await fetch(`${API_URL}/api/tasks/${taskId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) {
          throw new Error('Failed to update task status');
        }
        
        // Reload the page to reflect changes
        window.location.reload();
        
      } catch (error) {
        console.error('Error updating task status:', error);
        alert('Failed to update task status. Please try again.');
      }
    }
    
    // Confirm task cancellation
    function confirmCancelTask(taskId) {
      if (confirm('Are you sure you want to cancel this task? This will revert it to Open status and remove the assigned user.')) {
        updateTaskStatus(taskId, 'Open');
      }
    }
    
    // Confirm task deletion
    function confirmDeleteTask(taskId) {
      if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
        deleteTask(taskId);
      }
    }
    
    // Delete task
    async function deleteTask(taskId) {
      try {
        const API_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:9000';
        const token = localStorage.getItem('token');
        
        if (!token) {
          alert('You must be logged in to delete tasks.');
          return;
        }
        
        // Send delete request to server
        const response = await fetch(`${API_URL}/api/tasks/${taskId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to delete task');
        }
        
        // Redirect to dashboard
        alert('Task deleted successfully!');
        window.location.href = 'dashboard.html';
        
      } catch (error) {
        console.error('Error deleting task:', error);
        alert('Failed to delete task. Please try again.');
      }
    }
    
    // Logout function
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('userId');
      localStorage.removeItem('userEmail');
      
      window.location.href = 'login.html';
    }

    // Add event listener to copy phone number button
    document.addEventListener('DOMContentLoaded', function() {
      const callPhoneLink = document.getElementById('call-phone-link');
      if (callPhoneLink) {
        callPhoneLink.addEventListener('click', function() {
          const phoneNumber = document.getElementById('call-poster-phone').textContent;
          
          // Create a temporary input element
          const tempInput = document.createElement('input');
          tempInput.value = phoneNumber;
          document.body.appendChild(tempInput);
          
          // Select and copy the text
          tempInput.select();
          document.execCommand('copy');
          
          // Remove the temporary element
          document.body.removeChild(tempInput);
          
          // Change button text temporarily
          const originalText = this.innerHTML;
          this.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
          
          // Restore original text after 2 seconds
          setTimeout(() => {
            this.innerHTML = originalText;
          }, 2000);
        });
      }
    });
  </script>
  <script src="js/notification-handler.js"></script>
  <script src="js/chat.js"></script>
  <script src="js/chat-system.js"></script>
  <script src="js/chat-notifications.js"></script>
</body>
</html>
